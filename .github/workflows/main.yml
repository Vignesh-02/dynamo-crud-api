name: DEPLOY DYNAMO CRUD API

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Start timer
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy with Serverless
        uses: serverless/github-action@v3.1
        with:
          args: deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

      # FAILURE MESSAGE (Parent)
      - name: Notify Slack - Failure
        if: failure()
        run: |
          START_TIME="${{ steps.timer.outputs.start }}"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "Deployment failed after ${DURATION}s"

          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "ðŸš¨ Deployment Failed" }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Service:*\nDynamo CRUD API" },
                  { "type": "mrkdwn", "text": "*Environment:*\nProduction" },
                  { "type": "mrkdwn", "text": "*Branch:*\n'${{ github.ref_name }}'" },
                  { "type": "mrkdwn", "text": "*Duration:*\n'"$DURATION"'s" }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n*Triggered by:* ${{ github.actor }}"
                }
              }
            ]
          }' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      # ðŸŸ¢ SUCCESS MESSAGE
      - name: Notify Slack - Success
        if: success()
        run: |
          
          START_TIME="${{ steps.timer.outputs.start }}"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "Deployment succeeded in ${DURATION}s"
          
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "âœ… Deployment Successful" }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Service:*\nDynamo CRUD API" },
                  { "type": "mrkdwn", "text": "*Environment:*\nProduction" },
                  { "type": "mrkdwn", "text": "*Branch:*\n'${{ github.ref_name }}'" },
                  { "type": "mrkdwn", "text": "*Duration:*\n'"$DURATION"'s" }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|View Commit>\n*Deployed by:* ${{ github.actor }}"
                }
              }
            ]
          }' \
          ${{ secrets.SLACK_WEBHOOK_URL }}